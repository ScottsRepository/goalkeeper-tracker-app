<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBGK GOALKEEPER TRACKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- BRANDING & AESTHETICS (Based on BBGK website look) --- */
        
        /* Core Colors */
        :root {
            --color-primary-bg: #0A0A0A; /* Deep Dark Background */
            --color-secondary-bg: #1A1A1A; /* Panel Background */
            --color-accent-green: #32cd32; /* Lawn Green (BBGK) */
            --color-cogniverse-teal: #20c997; /* Teal/Cyan (CogniverseAi) */
            --color-text-light: #f5f5f5;
            --color-danger-red: #e53935;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary-bg); 
            color: var(--color-text-light);
        }
        
        /* Container Panels */
        .container-panel {
            background-color: var(--color-secondary-bg); 
            border: 1px solid #333;
            border-radius: 0.75rem; /* Slightly more rounded */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.7); /* Deeper shadow */
        }

        /* Stat Boxes */
        .stat-box {
            background-color: #242424;
            border-radius: 0.5rem;
            border: 1px solid #3a3a3a;
        }
        .stat-value {
            color: var(--color-accent-green); 
            text-shadow: 0 0 8px rgba(50, 205, 50, 0.7); /* Enhanced Neon shadow effect */
        }
        
        /* Action Buttons */
        .action-button {
            transition: all 0.15s ease-in-out;
            background-color: var(--color-accent-green);
            color: var(--color-primary-bg); /* Dark text for max contrast */
            font-weight: 700;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(50, 205, 50, 0.3); /* Green glow shadow */
        }
        .action-button:hover {
            background-color: #28a428; 
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 6px 12px rgba(50, 205, 50, 0.5);
        }
        .action-button:active {
            transform: scale(0.98);
        }

        /* Specific override for Goal Conceded/Error button (Danger Red) */
        #goal-btn, #unforced-error-btn {
            background-color: var(--color-danger-red);
            box-shadow: 0 4px 8px rgba(229, 57, 53, 0.4);
            color: var(--color-text-light);
        }
        #goal-btn:hover, #unforced-error-btn:hover {
            background-color: #c62828;
            box-shadow: 0 6px 12px rgba(229, 57, 53, 0.6);
        }

        /* Zonal Grid (Save/Goal) */
        .zone-grid-item {
            cursor: pointer;
            transition: background-color 0.1s;
            background-color: #242424;
            color: var(--color-text-light);
        }
        .zone-grid-item:hover {
            background-color: #383838;
        }

        /* NEW: Contact Zones Grid (4x4) */
        .contact-zone-item {
            cursor: pointer;
            transition: background-color 0.1s;
            background-color: #242424;
            color: var(--color-text-light);
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative; 
            z-index: 20;
            
            /* Default thin border for all cells */
            border-width: 1px;
            border-style: solid;
            border-color: #383838;
        }
        .contact-zone-item:hover {
            background-color: #383838;
        }
        
        /* --- CRITICAL FIX: Thicker border for C2 and C3 (The new furthest zone) --- */

        /* 1. Apply visual emphasis (glow) and default thick borders to the new zones */
        [data-zone="C2"], [data-zone="C3"] {
            /* Ensure the thick border is present for the new zones */
            box-shadow: 0 0 8px var(--color-accent-green); 
            border-color: var(--color-accent-green) !important;
            border-width: 3px; 
        }

        /* 2. C2 (Left side of the pair): Keep Left, Top, Bottom thick. Hide the Right edge (internal line) */
        [data-zone="C2"] {
            border-right-width: 0.5px !important; 
            /* Match the background color to visually eliminate the separation */
            border-right-color: var(--color-secondary-bg) !important; 
        }

        /* 3. C3 (Right side of the pair): Keep Right, Top, Bottom thick. Hide the Left edge (internal line) */
        [data-zone="C3"] {
            border-left-width: 0.5px !important;
            /* Match the background color to visually eliminate the separation */
            border-left-color: var(--color-secondary-bg) !important;
        }
        
        /* 4. Ensure C14 and C15 revert to thin dark borders (overrides from previous fix) */
        [data-zone="C14"], [data-zone="C15"] {
            border-color: #383838 !important;
            border-width: 1px !important;
            box-shadow: none !important;
        }

        /* --- VISUAL FEEDBACK ANIMATIONS --- */
        .action-button.flash-success {
            animation: success-flash 0.2s ease-out;
        }
        @keyframes success-flash {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(50, 205, 50, 1); }
            50% { transform: scale(0.98); background-color: #50e050; } 
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(50, 205, 50, 0.3); }
        }

        .action-button.flash-fail {
            animation: fail-flash 0.2s ease-out;
        }
        @keyframes fail-flash {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(229, 57, 53, 1); }
            50% { transform: scale(0.98); background-color: #ff5252; } 
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(229, 57, 53, 0.4); }
        }
        
        /* Custom Modal for Error/System Messages */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--color-secondary-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            border: 3px solid var(--color-accent-green); 
            box-shadow: 0 0 25px rgba(50, 205, 50, 0.6); 
        }

        /* Logo Placeholder Styling */
        .logo-placeholder {
            width: 50px;
            height: 50px;
            background-color: var(--color-accent-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-primary-bg);
            font-weight: bold;
            font-size: 24px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        /* --- SPLASH SCREEN STYLES (NEW) --- */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-primary-bg); /* Use the existing dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Ensure it's on top of all other content */
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }

        .fade-out {
            opacity: 0 !important;
        }

        /* Subtle animation for the logo */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .splash-screen img {
            /* Keep original class for base size: h-48 */
            animation: pulse 1.5s infinite; 
            /* Media query for larger screens, increase size further */
            @media (min-width: 768px) {
                height: 30vh; /* Use viewport height for better scaling on tablets/desktops */
            }
        }
        
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="splash-screen" class="splash-screen">
        <img src="https://raw.githubusercontent.com/ScottsRepository/goalkeeper-tracker-app/main/Company%20Logo%20-%20Developed%20By.png" 
             alt="CogniverseAi Logo" 
             class="h-48 w-auto"> 
             </div>
    <div id="custom-error-modal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-red-400">System Message</h3>
            <p id="modal-message" class="text-gray-300"></p>
            <button onclick="document.getElementById('custom-error-modal').style.display = 'none';"
                    class="mt-6 w-full py-3 bg-[var(--color-accent-green)] hover:bg-[#28a428] text-black font-bold rounded-lg shadow-lg transition-colors">
                Close
            </button>
        </div>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <div class="flex items-center justify-center mb-2">
                <div class="logo-placeholder">BB</div> 
                <h1 class="text-6xl font-extrabold tracking-tight uppercase" style="color: var(--color-accent-green);">BBGK</h1>
            </div>
            <p class="text-gray-400 mt-2 text-xl font-light">Pro Goalkeeper Performance Tracker</p>
            <p class="text-xs font-medium tracking-wider mt-1" style="color: var(--color-cogniverse-teal);">Developed by CogniverseAi</p>
        </header>
        
        <div class="container-panel p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-gray-200">Game Information</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="gk-name" class="block text-sm font-medium text-gray-400">Goalkeeper Name</label>
                    <input type="text" id="gk-name" value="Brooke Hurry" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                </div>
                <div>
                    <label for="game-date" class="block text-sm font-medium text-gray-400">Game Date</label>
                    <input type="date" id="game-date" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                </div>
                <div>
                    <label for="opposition" class="block text-sm font-medium text-gray-400">Opposition</label>
                    <input type="text" id="opposition" placeholder="e.g., The Rivals FC" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                </div>
                <div>
                    <label for="game-no" class="block text-sm font-medium text-gray-400">Game Number</label>
                    <input type="number" id="game-no" min="1" value="1" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                </div>
                <div>
                    <label for="h-a" class="block text-sm font-medium text-gray-400">Home / Away</label>
                    <select id="h-a" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                        <option value="H">Home</option>
                        <option value="A">Away</option>
                    </select>
                </div>
                <div>
                    <label for="final-score" class="block text-sm font-medium text-gray-400">Final Result</label>
                    <select id="final-score" class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner">
                        <option value="W">Win</option>
                        <option value="D">Draw</option>
                        <option value="L">Loss</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="game-comments" class="block text-sm font-medium text-gray-400">Game Notes / Key Observations</label>
                <textarea id="game-comments" rows="3" placeholder="Enter notes on shot quality, match intensity, weather conditions, or tactical setup..." 
                          class="mt-1 block w-full rounded-md bg-[#242424] border-gray-600 text-white p-3 shadow-inner resize-none"></textarea>
            </div>
        </div>

        <div class="container-panel p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-gray-200">Match Overview</h2>
            <div id="match-stats-output" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="stat-box p-4">
                    <p class="text-4xl font-extrabold stat-value" id="stat-saves">0</p>
                    <p class="text-sm text-gray-400 mt-1">Saves Made</p>
                </div>
                <div class="stat-box p-4">
                    <p class="text-4xl font-extrabold stat-value" id="stat-goals">0</p>
                    <p class="text-sm text-gray-400 mt-1">Goals Conceded</p>
                </div>
                <div class="stat-box p-4">
                    <p class="text-4xl font-extrabold stat-value" id="stat-save-pct">0%</p>
                    <p class="text-sm text-gray-400 mt-1">Save %</p>
                </div>
                <div class="stat-box p-4">
                    <p class="text-4xl font-extrabold stat-value" id="stat-total-shots">0</p>
                    <p class="text-sm text-gray-400 mt-1">Shots Faced</p>
                </div>
            </div>
            <p id="user-id-display" class="text-xs text-gray-500 mt-4 text-right">Running in Local Mode. Data will not be saved.</p>
        </div>

        <div class="container-panel p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-gray-200">Log Actions</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="shot-faced-btn" data-type="Shots Faced" class="action-button p-4 text-lg">Shot Faced</button>
                <button id="save-btn" data-type="Saves Made" class="action-button p-4 text-lg">Save</button>
                <button id="goal-btn" data-type="Goals Conceded" class="action-button p-4 text-lg">Goal Conceded</button>
                <button id="unforced-error-btn" data-type="Unforced Goal Errors" class="action-button p-4 text-lg">Unforced Error</button>
                
                <button id="cross-claimed-btn" data-type="Crosses Claimed" class="action-button p-4 text-lg">Cross Claimed</button>
                <button id="punch-completed-btn" data-type="Punches Completed" class="action-button p-4 text-lg">Punch Completed</button>
                <button id="interception-made-btn" data-type="Interceptions Made" class="action-button p-4 text-lg">Interception Made</button>
                
                <button id="1v1-won-btn" data-type="1v1s Won" class="action-button p-4 text-lg">1v1 Won</button>
                <button id="play-make-hands-btn" data-type="Play Make (Hands)" class="action-button p-4 text-lg">Play Make (Hands)</button>
                <button id="play-make-feet-btn" data-type="Play Make (Feet)" class="action-button p-4 text-lg">Play Make (Feet)</button>
            </div>
        </div>

        <div class="container-panel p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-gray-200">3. Shot & Goal Zonal Analysis</h2>

            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <h3 class="text-xl text-center font-bold mb-3" style="color: var(--color-accent-green);">Save Zones</h3>
                    <div id="save-zones-grid" class="grid grid-cols-3 grid-rows-3 h-64 w-full border-4 border-dashed border-[var(--color-accent-green)] rounded-lg overflow-hidden">
                        <div data-zone="TL" class="zone-grid-item flex items-center justify-center border border-[#383838]">TL</div>
                        <div data-zone="TC" class="zone-grid-item flex items-center justify-center border border-[#383838]">TC</div>
                        <div data-zone="TR" class="zone-grid-item flex items-center justify-center border border-[#383838]">TR</div>
                        <div data-zone="ML" class="zone-grid-item flex items-center justify-center border border-[#383838]">ML</div>
                        <div data-zone="MC" class="zone-grid-item flex items-center justify-center border border-[#383838]">MC</div>
                        <div data-zone="MR" class="zone-grid-item flex items-center justify-center border border-[#383838]">MR</div>
                        <div data-zone="BL" class="zone-grid-item flex items-center justify-center border border-[#383838]">BL</div>
                        <div data-zone="BC" class="zone-grid-item flex items-center justify-center border border-[#383838]">BC</div>
                        <div data-zone="BR" class="zone-grid-item flex items-center justify-center border border-[#383838]">BR</div>
                    </div>
                </div>

                <div class="flex-1">
                    <h3 class="text-xl text-center text-red-500 mb-3 font-bold">Goals Conceded Zones</h3>
                    <div id="goals-zones-grid" class="grid grid-cols-3 grid-rows-3 h-64 w-full border-4 border-dashed border-red-700 rounded-lg overflow-hidden">
                        <div data-zone="TL" class="zone-grid-item flex items-center justify-center border border-[#383838]">TL</div>
                        <div data-zone="TC" class="zone-grid-item flex items-center justify-center border border-[#383838]">TC</div>
                        <div data-zone="TR" class="zone-grid-item flex items-center justify-center border border-[#383838]">TR</div>
                        <div data-zone="ML" class="zone-grid-item flex items-center justify-center border border-[#383838]">ML</div>
                        <div data-zone="MC" class="zone-grid-item flex items-center justify-center border border-[#383838]">MC</div>
                        <div data-zone="MR" class="zone-grid-item flex items-center justify-center border border-[#383838]">MR</div>
                        <div data-zone="BL" class="zone-grid-item flex items-center justify-center border border-[#383838]">BL</div>
                        <div data-zone="BC" class="zone-grid-item flex items-center justify-center border border-[#383838]">BC</div>
                        <div data-zone="BR" class="zone-grid-item flex items-center justify-center border border-[#383838]">BR</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container-panel p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-gray-200">4. Contact Zones (18-Yard Box)</h2>
            <p class="text-sm text-gray-400 mb-4">Click the zone where the GK made contact with the ball (e.g., claim, punch, clearance, 1v1 dive).</p>
            <div id="contact-zones-grid" class="grid grid-cols-4 grid-rows-4 h-96 w-full mx-auto border-4 border-solid border-gray-500 rounded-lg overflow-hidden relative">
                <div class="absolute inset-x-0 bottom-0 h-1 bg-gray-500 z-10"></div>
                <div data-zone="C1" class="contact-zone-item">C1<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C2" class="contact-zone-item">C2<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C3" class="contact-zone-item">C3<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C4" class="contact-zone-item">C4<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C5" class="contact-zone-item">C5<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C6" class="contact-zone-item">C6<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C7" class="contact-zone-item">C7<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C8" class="contact-zone-item">C8<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C9" class="contact-zone-item">C9<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C10" class="contact-zone-item">C10<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C11" class="contact-zone-item">C11<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C12" class="contact-zone-item">C12<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C13" class="contact-zone-item">C13<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C14" class="contact-zone-item">C14<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C15" class="contact-zone-item">C15<span class="text-sm text-gray-500"> (0)</span></div>
                <div data-zone="C16" class="contact-zone-item">C16<span class="text-sm text-gray-500"> (0)</span></div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4">
            <button id="save-data-btn" disabled class="flex-1 py-4 bg-gray-700 cursor-not-allowed text-gray-400 font-bold rounded-xl shadow-lg">
                <span class="text-xl">Cloud Saving Disabled (Local Only)</span>
            </button>
            <button id="generate-pdf-btn" class="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-colors">
                <span class="text-xl">Generate PDF Report</span>
            </button>
            <button id="reset-btn" class="flex-1 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition-colors">
                <span class="text-xl">Reset Session</span>
            </button>
        </div>

        <footer class="text-center mt-10">
            <p class="text-sm text-gray-500">GK Tracker App developed by <span style="color: var(--color-cogniverse-teal);">CogniverseAi</span></p>
        </footer>

    </div>
    
    <script>
        // Global variables for the counter logic and zone data
        let sessionData = {};
        let zoneCounts = {
            saves: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
            goals: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
            contact: { C1: 0, C2: 0, C3: 0, C4: 
                0, C5: 0, C6: 0, C7: 0, C8: 0, C9: 0, C10: 0, C11: 0, C12: 0, C13: 0, C14: 0, C15: 0, C16: 0 }
        };

        // Utility function to show custom system messages
        function showCustomMessage(message, isError = true, title = "System Message") {
            const modal = document.getElementById('custom-error-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').style.color = isError ? '#f87171' : 'var(--color-accent-green)'; // Red or Green
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }

        // 1. Core Data and Display Logic
        function initializeSessionData() {
            sessionData = {
                'Shots Faced': 0, // This counter is now exclusively for OFF-TARGET shots
                'Saves Made': 0,
                'Goals Conceded': 0,
                'Unforced Goal Errors': 0,
                'Crosses Claimed': 0,
                'Punches Completed': 0,
                'Interceptions Made': 0,
                '1v1s Won': 0,
                'Play Make (Hands)': 0,
                'Play Make (Feet)': 0,
            };
            zoneCounts = {
                saves: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
                goals: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
                contact: { C1: 0, C2: 0, C3: 0, C4: 0, C5: 0, C6: 0, C7: 0, C8: 0, C9: 0, C10: 0, C11: 0, C12: 0, C13: 0, C14: 0, C15: 0, C16: 0 }
            };

            // Reset Input Fields and Selects to their default/placeholder values
            document.getElementById('gk-name').value = "Brooke Hurry";
            document.getElementById('game-date').value = "";
            document.getElementById('opposition').value = "";
            document.getElementById('game-no').value = 1;
            document.getElementById('h-a').value = "H";
            document.getElementById('final-score').value = "W";
            document.getElementById('game-comments').value = "";
        }

        // FIX 2 & 4: Corrected calculation for Match Overview
        function updateDisplay() {
            // Shots On Target (Used for Save %)
            const totalShotsOnTarget = sessionData['Saves Made'] + sessionData['Goals Conceded'];
            
            // Total Shots Faced (Includes Saves, Goals, and Off-Target Shots)
            const totalShots = totalShotsOnTarget + sessionData['Shots Faced'];
            
            // Save % calculation
            const savePct = totalShotsOnTarget > 0 ? ((sessionData['Saves Made'] / totalShotsOnTarget) * 100).toFixed(0) : 0;
            
            document.getElementById('stat-saves').textContent = sessionData['Saves Made'];
            document.getElementById('stat-goals').textContent = sessionData['Goals Conceded'];
            document.getElementById('stat-save-pct').textContent = `${savePct}%`;
            document.getElementById('stat-total-shots').textContent = totalShots;

            // Update Zonal Counts
            Object.entries(zoneCounts.saves).forEach(([zone, count]) => {
                const el = document.querySelector(`#save-zones-grid div[data-zone="${zone}"]`);
                if (el) el.innerHTML = `${zone}<span class="text-sm text-gray-500"> (${count})</span>`;
            });
            Object.entries(zoneCounts.goals).forEach(([zone, count]) => {
                const el = document.querySelector(`#goals-zones-grid div[data-zone="${zone}"]`);
                if (el) el.innerHTML = `${zone}<span class="text-sm text-gray-500"> (${count})</span>`;
            });
            Object.entries(zoneCounts.contact).forEach(([zone, count]) => {
                const el = document.querySelector(`#contact-zones-grid div[data-zone="${zone}"]`);
                if (el) el.innerHTML = `${zone}<span class="text-sm text-gray-500"> (${count})</span>`;
            });
        }

        // FIX 1: Removed pop-up and redundant 'Shots Faced' logic
        function handleCounterClick(type, button) {
            sessionData[type]++;
            updateDisplay();

            // Add visual feedback
            if (type.includes('Goal') || type.includes('Error')) {
                button.classList.add('flash-fail');
                setTimeout(() => button.classList.remove('flash-fail'), 300);
            } else {
                button.classList.add('flash-success');
                setTimeout(() => button.classList.remove('flash-success'), 300);
            }

            // NOTE: The separate logic to increment Shots Faced when Save/Goal is pressed has been REMOVED.
            // The `updateDisplay` function now calculates the total shots correctly based on the three counters: Saves, Goals, and Shots Faced (Off Target).
        }

        // FIX 3: Zone clicks should ONLY update the zone detail, not the Match Overview.
        function handleZoneClick(type, zone, element) {
            if (type === 'save') {
                zoneCounts.saves[zone]++;
                element.innerHTML = `${zone}<span class="text-sm text-gray-500"> (${zoneCounts.saves[zone]})</span>`;
                // Add a visual flash
                element.style.backgroundColor = 'var(--color-accent-green)';
                element.style.color = 'var(--color-primary-bg)';
                setTimeout(() => {
                    element.style.backgroundColor = '#242424';
                    element.style.color = 'var(--color-text-light)';
                }, 300);
            } else if (type === 'goals') {
                zoneCounts.goals[zone]++;
                element.innerHTML = `${zone}<span class="text-sm text-gray-500"> (${zoneCounts.goals[zone]})</span>`;
                // Add a visual flash
                element.style.backgroundColor = 'var(--color-danger-red)';
                setTimeout(() => element.style.backgroundColor = '#242424', 300);
            }
            // Do NOT call updateDisplay() here to avoid double-counting in the Match Overview.
        }

        function handleContactZoneClick(zone) {
            zoneCounts.contact[zone]++;
            updateDisplay();

            const element = document.querySelector(`#contact-zones-grid div[data-zone="${zone}"]`);

            // Add a visual flash
            element.style.backgroundColor = 'var(--color-cogniverse-teal)';
            setTimeout(() => element.style.backgroundColor = '#242424', 200);
        }


        // 3. PDF Generation Logic (FIX 5: C2/C3 Border)
        function generatePDFReport() {
            try {
                // Ensure jsPDF is available
                if (typeof window.jspdf.jsPDF !== 'function') {
                    showCustomMessage("PDF library not loaded. Please check internet connection.", true);
                    return;
                }

                // Gather Metadata
                const gkName = document.getElementById('gk-name').value || 'Unknown GK';
                const gameDate = document.getElementById('game-date').value || 'N/A';
                const opposition = document.getElementById('opposition').value || 'Unknown Opponent';
                const gameNo = document.getElementById('game-no').value;
                const hA = document.getElementById('h-a').value;
                const finalScore = document.getElementById('final-score').value;
                const comments = document.getElementById('game-comments').value || 'No specific notes recorded.';

                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let y = 15;
                const lineHeight = 7;
                const margin = 10;
                // --- CORE COLORS ---
                const headerColor = "#32cd32"; // Lawn Green (BBGK Green)
                const secondaryColor = "#1A1A1A";
                const darkTextColor = "#0A0A0A";
                const lightTextColor = "#f5f5f5";
                // ---

                // Utility function to draw a section header
                function drawHeader(title) {
                    doc.setFillColor(headerColor);
                    doc.rect(margin, y, 190, lineHeight, 'F');
                    doc.setTextColor(darkTextColor);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, margin + 2, y + 5);
                    y += lineHeight + 2;
                    doc.setTextColor(lightTextColor);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                }

                // Page 1: Summary & Game Info
                doc.setTextColor(headerColor);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('BBGK GOALKEEPER PERFORMANCE REPORT', margin, y);
                y += lineHeight;
                doc.setTextColor('#20c997'); // Cogniverse Teal
                doc.setFontSize(10);
                doc.text('Developed by CogniverseAi', margin, y);
                y += lineHeight + 5;


                // --- Game Information ---
                drawHeader('Game Information');

                doc.setFillColor(secondaryColor);
                doc.rect(margin, y, 190, lineHeight * 6, 'F'); // Background box for info
                doc.setTextColor(lightTextColor);
                doc.text(`Goalkeeper: ${gkName}`, margin + 2, y + lineHeight);
                doc.text(`Game Date: ${gameDate}`, margin + 65, y + lineHeight);
                doc.text(`Game #: ${gameNo}`, margin + 125, y + lineHeight);
                
                doc.text(`Opposition: ${opposition}`, margin + 2, y + lineHeight * 2);
                doc.text(`Home/Away: ${hA}`, margin + 65, y + lineHeight * 2);
                doc.text(`Result: ${finalScore}`, margin + 125, y + lineHeight * 2);
                
                doc.text(`Notes: ${comments}`, margin + 2, y + lineHeight * 3.5, { maxWidth: 185 });
                y += lineHeight * 6 + 5;

                // --- Match Overview ---
                drawHeader('Match Overview');
                
                const totalShotsOnTarget = sessionData['Saves Made'] + sessionData['Goals Conceded'];
                const totalShots = totalShotsOnTarget + sessionData['Shots Faced'];
                const savePct = totalShotsOnTarget > 0 ? ((sessionData['Saves Made'] / totalShotsOnTarget) * 100).toFixed(0) : 0;
                
                const stats = [
                    { label: 'Total Shots Faced', value: totalShots, x: margin + 2 },
                    { label: 'Saves Made', value: sessionData['Saves Made'], x: margin + 50 },
                    { label: 'Goals Conceded', value: sessionData['Goals Conceded'], x: margin + 98 },
                    { label: 'Save %', value: `${savePct}%`, x: margin + 146 }
                ];
                
                doc.setFillColor(secondaryColor);
                doc.rect(margin, y, 190, lineHeight * 3, 'F');
                doc.setTextColor(headerColor);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                
                stats.forEach( (stat, index) => {
                    doc.text(String(stat.value), stat.x, y + lineHeight);
                    doc.setTextColor(lightTextColor);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(stat.label, stat.x, y + lineHeight * 2);
                    doc.setTextColor(headerColor);
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                });

                y += lineHeight * 3 + 5;

                // --- Logged Actions (FIX 4: Renamed for clarity) ---
                drawHeader('Other Goalkeeping Actions');
                
                doc.setFillColor(secondaryColor);
                // Calculate required height based on number of logged items
                const actionsToLog = Object.entries(sessionData).filter(([key, value]) => !['Shots Faced', 'Saves Made', 'Goals Conceded'].includes(key) && value > 0);
                const rows = Math.ceil(actionsToLog.length / 3) || 1;
                const blockHeight = rows * lineHeight + lineHeight; 
                doc.rect(margin, y, 190, blockHeight, 'F');

                doc.setTextColor(lightTextColor);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');

                let currentY = y;
                actionsToLog.forEach(([key, value], index) => {
                    if (index % 3 === 0) {
                        currentY += lineHeight;
                    }
                    const x = margin + 2 + (index % 3) * 63;
                    doc.text(`${key}: ${value}`, x, currentY);
                });

                if (actionsToLog.length > 0) y = currentY + lineHeight + 5;
                else y += blockHeight + 5; // Reserve space if nothing logged

                doc.addPage();
                y = 15;

                // Page 2: Zonal Analysis
                doc.setTextColor(headerColor);
                doc.setFontSize(16);
                doc.text('Zonal Analysis', margin, y);
                y += lineHeight + 5;

                // --- Shot Zones (Saves) ---
                doc.setTextColor(headerColor);
                doc.setFontSize(12);
                doc.text('Save Locations', margin, y);
                y += lineHeight;

                doc.setFillColor(secondaryColor);
                doc.rect(margin, y, 190, 50, 'F'); // Background box for grid
                doc.setTextColor(lightTextColor);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');

                // Draw the 3x3 Grid for Saves
                const startY = y;
                const zoneWidth = 190 / 3;
                const zoneHeight = 50 / 3;
                const zones = ['TL', 'TC', 'TR', 'ML', 'MC', 'MR', 'BL', 'BC', 'BR'];

                doc.setFont(undefined, 'normal');
                zones.forEach((zone, index) => {
                    const col = index % 3;
                    const row = Math.floor(index / 3);
                    const x = margin + col * zoneWidth;
                    const yPos = startY + row * zoneHeight;
                    const count = zoneCounts.saves[zone];

                    // Draw cell borders
                    doc.setDrawColor('#333');
                    doc.rect(x, yPos, zoneWidth, zoneHeight);

                    // Draw text
                    doc.setTextColor(count > 0 ? headerColor : '#666');
                    doc.text(`${zone} (${count})`, x + zoneWidth / 2, yPos + zoneHeight / 2 + 1, { align: 'center' });
                });
                y = startY + 50 + 5;
                
                // --- Goal Conceded Zones ---
                doc.setTextColor(headerColor);
                doc.setFontSize(12);
                doc.text('Goal Conceded Locations', margin, y);
                y += lineHeight;

                doc.setFillColor(secondaryColor);
                doc.rect(margin, y, 190, 50, 'F'); // Background box for grid
                doc.setTextColor(lightTextColor);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');

                // Draw the 3x3 Grid for Goals
                const startYGoals = y;
                doc.setFont(undefined, 'normal');
                zones.forEach((zone, index) => {
                    const col = index % 3;
                    const row = Math.floor(index / 3);
                    const x = margin + col * zoneWidth;
                    const yPos = startYGoals + row * zoneHeight;
                    const count = zoneCounts.goals[zone];

                    // Draw cell borders
                    doc.setDrawColor('#333');
                    doc.rect(x, yPos, zoneWidth, zoneHeight);

                    // Draw text
                    doc.setTextColor(count > 0 ? '#f87171' : '#666'); // Red for goals
                    doc.text(`${zone} (${count})`, x + zoneWidth / 2, yPos + zoneHeight / 2 + 1, { align: 'center' });
                });
                y = startYGoals + 50 + 5;


                // --- Contact Zones (18-Yard Box) ---
                doc.setTextColor(headerColor);
                doc.setFontSize(12);
                doc.text('Contact Zones (18-Yard Box)', margin, y);
                y += lineHeight;

                // Draw the 4x4 Grid for Contact Zones
                const startYContact = y;
                const zoneWidthContact = 190 / 4;
                const zoneHeightContact = 90 / 4;
                const contactZones = Object.keys(zoneCounts.contact); // C1 to C16

                contactZones.forEach((zone, index) => {
                    const col = index % 4;
                    const row = Math.floor(index / 4);
                    const x = margin + col * zoneWidthContact;
                    const yPos = startYContact + row * zoneHeightContact;
                    const count = zoneCounts.contact[zone];
                    
                    // 1. Draw Fill
                    doc.setFillColor(secondaryColor);
                    doc.rect(x, yPos, zoneWidthContact, zoneHeightContact, 'F'); 

                    // 2. Draw Text
                    doc.setTextColor(count > 0 ? '#20c997' : '#666'); // Teal for contact
                    doc.setFontSize(8);
                    doc.text(`${zone} (${count})`, x + zoneWidthContact / 2, yPos + zoneHeightContact / 2 + 1, { align: 'center' });
                    
                    // 3. Draw Standard Borders (Handling C2/C3 internal line removal)
                    doc.setDrawColor('#333');
                    doc.setLineWidth(0.2); 
                    
                    if (zone === 'C2') {
                        // C2: Skip Right line
                        doc.line(x, yPos, x + zoneWidthContact, yPos); // Top
                        doc.line(x, yPos + zoneHeightContact, x + zoneWidthContact, yPos + zoneHeightContact); // Bottom
                        doc.line(x, yPos, x, yPos + zoneHeightContact); // Left
                    }
                    else if (zone === 'C3') {
                        // C3: Skip Left line
                        doc.line(x, yPos, x + zoneWidthContact, yPos); // Top
                        doc.line(x, yPos + zoneHeightContact, x + zoneWidthContact, yPos + zoneHeightContact); // Bottom
                        doc.line(x + zoneWidthContact, yPos, x + zoneWidthContact, yPos + zoneHeightContact); // Right
                    }
                    else {
                        doc.rect(x, yPos, zoneWidthContact, zoneHeightContact, 'S');
                    }
                    
                    // 4. FIX 5: Draw C2/C3 THICK BORDER OVERRIDE (Draws the outer wrapper)
                    if (zone === 'C2') {
                        doc.setDrawColor(headerColor); // Green
                        doc.setLineWidth(1.5); // Thicker line
                        
                        const rectX = x; 
                        const rectY = yPos; 
                        const rectW = zoneWidthContact * 2; // Width of C2 + C3
                        const rectH = zoneHeightContact; 
                        
                        // Draw the border of the combined box (C2/C3)
                        doc.rect(rectX, rectY, rectW, rectH, 'S');
                        
                        // Reset line width
                        doc.setLineWidth(0.2); 
                    }
                });
                y = startYContact + 90 + 5;

                // Save PDF
                doc.save(`BBGK_Report_${gkName.replace(/\s/g, '_')}_${gameDate}.pdf`);
                showCustomMessage("PDF report generated successfully!", false, "Success");

            } catch (error) {
                console.error("PDF generation error:", error);
                showCustomMessage(`Failed to generate PDF. Error: ${error.message}`, true);
            }
        }

        // 4. Initialization
        window.addEventListener('DOMContentLoaded', () => {

            // NEW: SPLASH SCREEN LOGIC
            const splash = document.getElementById('splash-screen');
            if (splash) {
                // Wait for 3 seconds before starting the fade out
                setTimeout(() => {
                    splash.classList.add('fade-out');

                    // After the fade out transition is complete (0.5s), hide it completely
                    setTimeout(() => {
                        splash.style.display = 'none';
                    }, 500); // Must match the CSS transition duration
                }, 3000); // 3 seconds total splash time
            }
            // END NEW SPLASH SCREEN LOGIC
            
            // 1. Initialize Data and Display
            initializeSessionData();
            updateDisplay();

            // 2. Setup Counter Button Listeners
            document.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    handleCounterClick(e.target.getAttribute('data-type'), e.target);
                });
            });

            // 3. Setup Shot/Goal Zonal Grid Listeners
            document.getElementById('save-zones-grid').addEventListener('click', (e) => {
                const zoneDiv = e.target.closest('.zone-grid-item');
                // FIX 3: Zone clicks do NOT update Match Overview (no updateDisplay call)
                if (zoneDiv) handleZoneClick('save', zoneDiv.getAttribute('data-zone'), zoneDiv);
            });

            document.getElementById('goals-zones-grid').addEventListener('click', (e) => {
                const zoneDiv = e.target.closest('.zone-grid-item');
                // FIX 3: Zone clicks do NOT update Match Overview (no updateDisplay call)
                if (zoneDiv) handleZoneClick('goals', zoneDiv.getAttribute('data-zone'), zoneDiv);
            });
            
            // 4. Setup Contact Zones Listener 
            document.getElementById('contact-zones-grid').addEventListener('click', (e) => {
                const zoneDiv = e.target.closest('.contact-zone-item');
                if (zoneDiv) handleContactZoneClick(zoneDiv.getAttribute('data-zone'));
            });


            // 5. Setup Control Buttons
            document.getElementById('generate-pdf-btn').addEventListener('click', generatePDFReport);

            document.getElementById('reset-btn').addEventListener('click', () => {
                initializeSessionData();
                updateDisplay();
                showCustomMessage("Session data has been successfully reset.", false);
            });
        });
    </script>
</body>
</html>
