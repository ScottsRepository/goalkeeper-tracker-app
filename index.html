<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBGK Pro Goalkeeper Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jspdf-autotable plugin for professional tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Custom Tailwind Configuration for "Inter" font and key variables */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --color-neon-blue: #00FFFF; /* Bright Cyan/Neon Blue */
            --color-accent-green: #34D399; /* Electric Green for success/Saves */
            --color-danger-red: #F87171; /* High-contrast red for Goals */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Absolute Black Background */
        }

        .card {
            background-color: #0A0A0A; /* Deep Black Surface */
            border: 1px solid #1F2937; /* Dark metal border */
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); /* Neon glow effect */
            color: #E5E7EB; /* Off-white text */
        }

        /* Module Header Styling */
        .module-header {
            border-bottom: 2px solid var(--color-neon-blue);
            box-shadow: 0 2px 5px rgba(0, 255, 255, 0.1);
        }

        /* Custom Counter Styling - Digital Display Look */
        .counter-container {
            display: grid;
            grid-template-columns: 1fr auto; 
            align-items: center;
            gap: 1rem;
        }

        .counter-block {
            display: flex;
            align-items: center;
            height: 52px; /* Fixed height for easy tapping */
        }

        .count-display {
            background-color: #111827; /* Dark background for display */
            border: 2px solid var(--color-neon-blue);
            color: var(--color-accent-green);
            font-size: 1.6rem; /* Large text for visibility */
            font-weight: 800;
            text-shadow: 0 0 5px rgba(52, 211, 153, 0.5); /* Neon text glow */
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }

        .count-display:active {
            transform: scale(0.95);
            opacity: 0.8;
            box-shadow: none;
        }

        .reset-button {
            background-color: #374151; /* Dark reset button */
            transition: background-color 0.1s;
            border-right: 1px solid #1F2937;
        }
        .reset-button:hover {
            background-color: #4B5563;
        }
        
        /* Goal Zone Styling - High-contrast grid */
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            aspect-ratio: 1 / 1; 
            border: 3px solid #1F2937;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
        }
        .zone {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 1px solid #1F2937;
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            color: #E5E7EB;
        }
        .zone:active {
            transform: scale(0.95);
        }
        .save-zone {
            background-color: rgba(0, 255, 255, 0.1); /* Transparent Neon Blue */
            color: var(--color-neon-blue);
        }
        .save-zone:hover {
            background-color: rgba(0, 255, 255, 0.2);
        }
        .goal-zone {
            background-color: rgba(248, 113, 128, 0.1); /* Transparent Red */
            color: var(--color-danger-red);
        }
        .goal-zone:hover {
            background-color: rgba(248, 113, 128, 0.2);
        }

        /* Input Styling */
        input[type="date"], input[type="text"], select {
            background-color: #1F2937 !important;
            border: 1px solid #374151 !important;
            color: #E5E7EB !important;
        }
        
    </style>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Loading/Auth Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="card p-6 rounded-xl bg-gray-800 shadow-2xl flex items-center space-x-3 border-2 border-cyan-500">
            <svg class="animate-spin h-5 w-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-white font-medium">System Initializing...</span>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-cyan-400 mb-2 tracking-widest" style="text-shadow: 0 0 10px #00FFFF;">BBGK PRO-TRACKER</h1>
            <p class="text-lg text-gray-500 font-mono">LIVE PERFORMANCE LOGGING INTERFACE</p>
        </header>

        <!-- Dynamic User/Session Info -->
        <div class="card p-4 mb-8 rounded-xl text-sm md:text-base border-cyan-500/30">
            <p class="font-semibold text-gray-400">SESSION ID: <span id="userIdDisplay" class="font-mono text-xs md:text-sm text-yellow-500 break-all">Awaiting Authentication...</span></p>
        </div>


        <!-- Modules A & B: Match Data and Raw Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
            
            <!-- Module A: Match Details & Live Analysis -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Match Data -->
                <div class="card p-6 rounded-xl border-cyan-500/30">
                    <h2 class="text-2xl font-bold mb-4 pb-2 text-cyan-400 module-header flex items-center">
                        <i data-lucide="calendar" class="w-6 h-6 mr-3 text-cyan-400"></i> MATCH DATA INPUT
                    </h2>
                    <div class="space-y-4">
                        <!-- Goalkeeper Details -->
                        <label class="block">
                            <span class="text-gray-400">Goalkeeper's Name:</span>
                            <input type="text" id="goalkeeper_name" placeholder="Enter Goalkeeper Name" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        </label>
                        <label class="block">
                            <span class="text-gray-400">Team Playing For:</span>
                            <input type="text" id="goalkeeper_team" placeholder="Enter Team Name" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        </label>
                        
                        <!-- Match Details -->
                        <label class="block">
                            <span class="text-gray-400">Game Date (YYYY-MM-DD):</span>
                            <input type="date" id="game_date" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        </label>
                        <label class="block">
                            <span class="text-gray-400">Opposition:</span>
                            <input type="text" id="opposition" placeholder="Enter Team Name" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-400">H/A:</span>
                                <select id="home_away" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                                    <option value="H">HOME</option>
                                    <option value="A">AWAY</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-gray-400">Score (Final):</span>
                                <input type="text" id="final_score" placeholder="0-0" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                            </label>
                        </div>
                        <label class="block">
                            <span class="text-gray-400">Result (W/D/L):</span>
                            <select id="result_wdl" class="mt-1 block w-full p-3 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="W">Win</option>
                                <option value="D">Draw</option>
                                <option value="L">Loss</option>
                                <option value="-">N/A</option>
                            </select>
                        </label>
                    </div>
                </div>

                <!-- Live Analysis Widget -->
                <div class="card p-6 rounded-xl border-cyan-500/30">
                    <h2 class="text-2xl font-bold mb-4 pb-2 text-white module-header flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 mr-3 text-accent-green"></i> LIVE STATS
                    </h2>
                    <div class="space-y-3 text-lg font-mono">
                        <p class="flex justify-between"><span>TOTAL SAVES:</span> <span id="live_saves" class="text-accent-green font-bold">0</span></p>
                        <p class="flex justify-between"><span>GOALS CONCEDED:</span> <span id="live_goals" class="text-danger-red font-bold">0</span></p>
                        <p class="flex justify-between border-t border-gray-700 pt-3"><span>SAVE PERCENTAGE:</span> <span id="live_save_pct" class="text-yellow-400 font-bold">0.0%</span></p>
                    </div>
                </div>
            </div>

            <!-- Module B: Raw Metrics Input (Tap Counters) -->
            <div class="lg:col-span-2 card p-6 rounded-xl border-cyan-500/30">
                <h2 class="text-2xl font-bold mb-6 pb-2 text-cyan-400 module-header flex items-center">
                    <i data-lucide="gauge" class="w-6 h-6 mr-3 text-cyan-400"></i> RAW PERFORMANCE METRICS
                </h2>
                
                <div class="space-y-6">
                    <!-- Shots & Goals -->
                    <div class="bg-[#111827] p-4 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-blue-400">ATTACK STOPPING</h3>
                        <div class="space-y-3">
                            <div id="counter_shots_faced" class="counter-container"></div>
                            <div id="counter_shots_saved" class="counter-container"></div>
                            <div id="counter_goals_against" class="counter-container"></div>
                            <div id="counter_unforced_goal_errors" class="counter-container"></div>
                        </div>
                    </div>
                    
                    <!-- 1v1s & Aerials -->
                    <div class="bg-[#111827] p-4 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-yellow-400">AREA COMMAND</h3>
                        <div class="space-y-3">
                            <div id="counter_1v1_battles" class="counter-container"></div>
                            <div id="counter_1v1s_won" class="counter-container"></div>
                            <div id="counter_crosses_claimed" class="counter-container"></div>
                            <div id="counter_punches_completed" class="counter-container"></div>
                            <div id="counter_interceptions_made" class="counter-container"></div>
                        </div>
                    </div>

                    <!-- Distribution -->
                    <div class="bg-[#111827] p-4 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-green-400">DISTRIBUTION QUALITY</h3>
                        <div class="space-y-3">
                            <div id="counter_playmake_hands" class="counter-container"></div>
                            <div id="counter_playmake_feet" class="counter-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module C: Zonal Analysis -->
        <div class="card p-6 rounded-xl mb-10 border-cyan-500/30">
            <h2 class="text-2xl font-bold mb-6 pb-2 text-cyan-400 module-header flex items-center">
                <i data-lucide="target" class="w-6 h-6 mr-3 text-cyan-400"></i> ZONAL ANALYSIS (TAP TO LOG)
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Save Zones -->
                <div id="saveZoneContainer">
                    <h3 class="text-xl font-semibold mb-4 text-gray-300">SAVE LOCATION (ATTEMPTS SAVED)</h3>
                    <!-- Canvas will be created here for PDF generation -->
                    <div id="save_zones_grid" class="goal-grid rounded-xl overflow-hidden shadow-lg shadow-cyan-500/10">
                        <!-- Zones created dynamically -->
                    </div>
                </div>

                <!-- Goals Conceded Zones -->
                <div id="goalZoneContainer">
                    <h3 class="text-xl font-semibold mb-4 text-gray-300">GOAL LOCATION (GOALS CONCEDED)</h3>
                     <!-- Canvas will be created here for PDF generation -->
                    <div id="goals_conceded_grid" class="goal-grid rounded-xl overflow-hidden shadow-lg shadow-red-500/10">
                        <!-- Zones created dynamically -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Action Button -->
        <div class="text-center p-6 card rounded-xl border-cyan-500/30">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="generateReportBtn" class="w-full md:w-auto px-10 py-4 bg-cyan-600 hover:bg-cyan-500 text-black font-extrabold text-xl rounded-xl shadow-lg shadow-cyan-500/50 transition-all transform hover:scale-105 active:scale-95 disabled:bg-gray-700 disabled:shadow-none disabled:text-gray-400" disabled>
                    <i data-lucide="save" class="w-6 h-6 mr-2 inline-block"></i> SAVE & GENERATE REPORT (PDF)
                </button>
                
                <!-- NEW RESET BUTTON -->
                <button id="resetAppBtn" class="w-full md:w-auto px-10 py-4 bg-gray-700 hover:bg-gray-600 text-white font-extrabold text-xl rounded-xl shadow-lg shadow-white/10 transition-all transform hover:scale-105 active:scale-95">
                    <i data-lucide="power" class="w-6 h-6 mr-2 inline-block"></i> RESET ALL DATA
                </button>
            </div>

            <p id="statusMessage" class="mt-4 text-base font-mono text-cyan-400 hidden"></p>
        </div>

        <!-- Modals for messages (Custom Alerts) -->
        <div id="successModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
            <div class="card p-8 rounded-xl max-w-sm mx-auto text-center border-green-500/50">
                <i data-lucide="check-circle" class="w-12 h-12 mx-auto text-green-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-white">SUCCESS! DATA SECURED.</h3>
                <p id="successMessage" class="text-gray-300 text-sm font-mono">Data saved successfully.</p>
                <button onclick="closeModal('successModal')" class="mt-4 px-6 py-2 bg-cyan-600 rounded-lg text-black font-semibold hover:bg-cyan-500">PROCEED</button>
            </div>
        </div>

        <div id="errorModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
            <div class="card p-8 rounded-xl max-w-sm mx-auto text-center border-red-500/50">
                <i data-lucide="x-octagon" class="w-12 h-12 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-white">SYSTEM ERROR</h3>
                <p id="errorMessage" class="text-gray-300 text-sm font-mono">An unknown error occurred.</p>
                <button onclick="closeModal('errorModal')" class="mt-4 px-6 py-2 bg-cyan-600 rounded-lg text-black font-semibold hover:bg-cyan-500">DISMISS</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL STATE & FIREBASE SETUP ---
        setLogLevel('debug');

        const { jsPDF } = window.jspdf;
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Ensure globals are defined or use defaults
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const STATE = {
            rawMetrics: {
                shots_faced: 0, shots_saved: 0, goals_against: 0, unforced_goal_errors: 0,
                '1v1_battles': 0, '1v1s_won': 0, crosses_claimed: 0, punches_completed: 0,
                interceptions_made: 0, playmake_hands: 0, playmake_feet: 0,
            },
            saveZones: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
            goalsConceded: { TL: 0, TC: 0, TR: 0, ML: 0, MC: 0, MR: 0, BL: 0, BC: 0, BR: 0 },
        };

        // Mapping for display names in the PDF
        const METRIC_DISPLAY_NAMES = {
            shots_faced: 'Total Shots Faced', shots_saved: 'Shots Saved', goals_against: 'Goals Conceded', unforced_goal_errors: 'Unforced Goal Errors',
            '1v1_battles': '1v1 Battles', '1v1s_won': '1v1s Won', crosses_claimed: 'Crosses Claimed', punches_completed: 'Punches Completed',
            interceptions_made: 'Interceptions Made', playmake_hands: 'Play-Make (Hands)', playmake_feet: 'Play-Make (Feet)',
        };
        
        // --- UTILITY FUNCTIONS ---
        
        window.closeModal = function(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        /** Shows a custom modal with a message. */
        function showModal(id, message) {
            const modal = document.getElementById(id);
            const msgElement = document.getElementById(`${id === 'successModal' ? 'success' : 'error'}Message`);
            msgElement.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /** Simple UUID generator */
        function generateUUID() {
            return crypto.randomUUID();
        }
        
        /** Updates the Live Analysis Widget */
        function updateLiveMetrics() {
            // Get combined counts from raw metrics and zonal counts
            const totalZonalSaves = Object.values(STATE.saveZones).reduce((a, b) => a + b, 0);
            const totalZonalGoals = Object.values(STATE.goalsConceded).reduce((a, b) => a + b, 0);
            
            // Total saves is raw metric + zonal count.
            const saves = STATE.rawMetrics.shots_saved + totalZonalSaves;
            const goals = STATE.rawMetrics.goals_against + totalZonalGoals;
            
            // Total opportunities: shots_faced should ideally include all shots, but for a calculated Save % 
            // from the app's logged saves/goals, we use (saves + goals).
            const totalOpportunities = saves + goals;
            
            const savePct = totalOpportunities > 0 ? (saves / totalOpportunities) * 100 : 0;

            document.getElementById('live_saves').textContent = saves;
            document.getElementById('live_goals').textContent = goals;
            document.getElementById('live_save_pct').textContent = `${savePct.toFixed(1)}%`;
        }

        /** Creates and sets up a tap-based counter for raw metrics. */
        function setupCounter(containerId, metricName, stateKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="text-gray-300 font-medium text-lg">${metricName}</div>
                <div class="counter-block">
                    <button class="reset-button text-cyan-400 px-4 h-full rounded-l-lg hover:bg-[#203040]" data-key="${stateKey}" data-action="reset">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                    <div id="${stateKey}_display" class="count-display text-center flex-grow p-2" data-key="${stateKey}" data-action="increment">
                        0
                    </div>
                </div>
            `;
            
            const display = document.getElementById(`${stateKey}_display`);
            const resetButton = container.querySelector('.reset-button');

            const updateDisplay = () => {
                display.textContent = STATE.rawMetrics[stateKey];
                updateLiveMetrics();
            };
            
            // Initial display update
            updateDisplay();

            const handleAction = (e) => {
                const key = e.currentTarget.dataset.key;
                const action = e.currentTarget.dataset.action;

                if (action === 'increment') {
                    STATE.rawMetrics[key]++;
                } else if (action === 'reset') {
                    STATE.rawMetrics[key] = 0;
                }
                updateDisplay();
            };

            display.addEventListener('click', handleAction);
            resetButton.addEventListener('click', handleAction);

            // Important: Re-create icons for the newly added buttons
            lucide.createIcons();
        }

        /** Creates and sets up the 3x3 zonal analysis grid. */
        function setupZonalGrid(containerId, stateObject, prefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            const zones = ['TL', 'TC', 'TR', 'ML', 'MC', 'MR', 'BL', 'BC', 'BR'];
            
            zones.forEach(zone => {
                const div = document.createElement('div');
                div.id = `${prefix}_${zone}`;
                div.className = `zone p-2 ${prefix === 'save' ? 'save-zone' : 'goal-zone'}`;
                
                // Click to increment
                div.addEventListener('click', () => {
                    stateObject[zone]++;
                    div.textContent = stateObject[zone];
                    updateLiveMetrics();
                });

                // Long press/Right click for reset
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault(); 
                    stateObject[zone] = 0;
                    div.textContent = stateObject[zone];
                    updateLiveMetrics();
                });

                // Initial display update
                div.textContent = stateObject[zone];
                
                container.appendChild(div);
            });
        }
        
        /** Initializes all dynamic UI elements (counters and zones). */
        function initializeUI() {
             // 1. Setup Raw Metrics Counters
            setupCounter('counter_shots_faced', 'Shots Faced (Raw)', 'shots_faced');
            setupCounter('counter_shots_saved', 'Shots Saved (Raw)', 'shots_saved');
            setupCounter('counter_goals_against', 'Goals Against (Raw)', 'goals_against');
            setupCounter('counter_unforced_goal_errors', 'Unforced Goal Errors', 'unforced_goal_errors');

            setupCounter('counter_1v1_battles', '1v1 Battles', '1v1_battles');
            setupCounter('counter_1v1s_won', '1v1s Won', '1v1s_won');
            setupCounter('counter_crosses_claimed', 'Crosses Claimed', 'crosses_claimed');
            setupCounter('counter_punches_completed', 'Punches Completed', 'punches_completed');
            setupCounter('counter_interceptions_made', 'Interceptions Made', 'interceptions_made');

            setupCounter('counter_playmake_hands', 'Play-Make (Hands)', 'playmake_hands');
            setupCounter('counter_playmake_feet', 'Play-Make (Feet)', 'playmake_feet');

            // 2. Setup Zonal Grids
            setupZonalGrid('save_zones_grid', STATE.saveZones, 'save');
            setupZonalGrid('goals_conceded_grid', STATE.goalsConceded, 'goal');
            
            // 3. Update Live Metrics Display
            updateLiveMetrics();
        }

        /** Resets all UI inputs and the application STATE */
        function resetState() {
            // Reset Raw Metrics
            Object.keys(STATE.rawMetrics).forEach(key => {
                STATE.rawMetrics[key] = 0;
                // Use a try-catch for safety in case the element hasn't loaded yet
                try { document.getElementById(`${key}_display`).textContent = 0; } catch (e) {}
            });

            // Reset Zonal Data and UI
            const zones = ['TL', 'TC', 'TR', 'ML', 'MC', 'MR', 'BL', 'BC', 'BR'];
            zones.forEach(zone => {
                STATE.saveZones[zone] = 0;
                STATE.goalsConceded[zone] = 0;
                try { 
                    document.getElementById(`save_${zone}`).textContent = 0;
                    document.getElementById(`goal_${zone}`).textContent = 0;
                } catch (e) {}
            });

            // Reset Input Fields
            try {
                document.getElementById('goalkeeper_name').value = '';
                document.getElementById('goalkeeper_team').value = '';
                document.getElementById('game_date').valueAsDate = new Date(); // Reset to today
                document.getElementById('opposition').value = '';
                document.getElementById('final_score').value = '';
                document.getElementById('home_away').value = 'H';
                document.getElementById('result_wdl').value = '-';
            } catch (e) {
                console.error("Error resetting input fields:", e);
            }


            updateLiveMetrics();
            showModal('successModal', 'All app data and counters have been successfully reset. Ready for a new match log.');
        }

        // --- PDF GENERATION ---

        function getMatchData() {
             const totalZonalSaves = Object.values(STATE.saveZones).reduce((a, b) => a + b, 0);
             const totalZonalGoals = Object.values(STATE.goalsConceded).reduce((a, b) => a + b, 0);
             const totalSaves = STATE.rawMetrics.shots_saved + totalZonalSaves;
             const totalGoals = STATE.rawMetrics.goals_against + totalZonalGoals;
             const totalOpportunities = totalSaves + totalGoals;
             const savePct = totalOpportunities > 0 ? (totalSaves / totalOpportunities) * 100 : 0;
            
            return {
                matchDetails: {
                    name: document.getElementById('goalkeeper_name').value || 'N/A',
                    team: document.getElementById('goalkeeper_team').value || 'N/A',
                    date: document.getElementById('game_date').value || 'N/A',
                    opposition: document.getElementById('opposition').value || 'N/A',
                    homeAway: document.getElementById('home_away').value || 'N/A',
                    score: document.getElementById('final_score').value || 'N/A',
                    result: document.getElementById('result_wdl').value || 'N/A',
                    gameId: generateUUID(),
                },
                performanceSummary: {
                    totalSaves: totalSaves,
                    totalGoals: totalGoals,
                    savePercentage: `${savePct.toFixed(1)}%`,
                },
                rawMetrics: STATE.rawMetrics,
                saveZones: STATE.saveZones,
                goalsConceded: STATE.goalsConceded,
            };
        }

        /**
         * Main PDF report generation function.
         */
        async function generatePDFReport() {
            const data = getMatchData();
            const doc = new jsPDF();
            let y = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;

            // --- 1. HEADER & LOGO ---
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 150, 255); // Blue
            doc.text("BBGK PERFORMANCE DATA PACK", margin, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Report Generated: ${new Date().toLocaleString()}`, margin, y);
            y += 5;
            
            // Placeholder for Logo (using a simple bounding box as we cannot load external images)
            doc.setDrawColor(0, 150, 255);
            doc.rect(pageWidth - 40, 10, 25, 20); // Placeholder box for logo
            doc.setTextColor(0, 150, 255);
            doc.text('BBGK', pageWidth - 35, 20, { align: 'center' });
            doc.setTextColor(0, 0, 0); // Reset text color to black
            y = 40; 

            // --- 2. MATCH DETAILS TABLE ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("MATCH DETAILS", margin, y);
            y += 3;

            const matchDataArray = [
                ['Goalkeeper', data.matchDetails.name, 'Team', data.matchDetails.team],
                ['Date', data.matchDetails.date, 'Opposition', data.matchDetails.opposition],
                ['H/A', data.matchDetails.homeAway, 'Final Score', data.matchDetails.score],
                ['Result (W/D/L)', data.matchDetails.result, 'Game ID', data.matchDetails.gameId.substring(0, 8) + '...'],
            ];

            doc.autoTable({
                startY: y + 2,
                head: [],
                body: matchDataArray,
                theme: 'grid',
                styles: { cellPadding: 2, fontSize: 10, textColor: [0, 0, 0] },
                headStyles: { fillColor: [240, 240, 240] },
                margin: { left: margin, right: margin },
                columnStyles: {
                    0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 30 },
                    2: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 30 },
                    1: { cellWidth: 60 },
                    3: { cellWidth: 60 },
                }
            });
            y = doc.autoTable.previous.finalY + 10;
            
            // --- 3. PERFORMANCE SUMMARY ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("PERFORMANCE SUMMARY", margin, y);
            y += 3;
            
            const summaryData = [
                ['Total Saves', data.performanceSummary.totalSaves.toString()],
                ['Goals Conceded', data.performanceSummary.totalGoals.toString()],
                ['Save Percentage', data.performanceSummary.savePercentage],
            ];
            
            doc.autoTable({
                startY: y + 2,
                head: [],
                body: summaryData,
                theme: 'grid',
                styles: { cellPadding: 2, fontSize: 10, textColor: [0, 0, 0] },
                headStyles: { fillColor: [240, 240, 240] },
                margin: { left: margin, right: pageWidth - (pageWidth / 3) }, // Keep this table narrow
                columnStyles: {
                    0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 40 },
                    1: { cellWidth: 40, halign: 'center' },
                }
            });
            y = doc.autoTable.previous.finalY + 10;
            
            // --- 4. RAW METRICS BREAKDOWN ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("RAW METRICS BREAKDOWN", margin, y);
            y += 3;

            // Prepare Raw Metrics for a nice 2-column table
            const rawMetricsTableData = [];
            let keys = Object.keys(data.rawMetrics);
            
            for (let i = 0; i < keys.length; i += 2) {
                const key1 = keys[i];
                const key2 = keys[i + 1];
                
                const row = [
                    METRIC_DISPLAY_NAMES[key1] || key1,
                    data.rawMetrics[key1].toString(),
                ];

                if (key2) {
                    row.push(METRIC_DISPLAY_NAMES[key2] || key2);
                    row.push(data.rawMetrics[key2].toString());
                } else {
                    row.push('', ''); // Pad the row if odd number of metrics
                }
                rawMetricsTableData.push(row);
            }
            
            doc.autoTable({
                startY: y + 2,
                head: [['Metric', 'Count', 'Metric', 'Count']],
                body: rawMetricsTableData,
                theme: 'grid',
                styles: { cellPadding: 2, fontSize: 10, textColor: [0, 0, 0] },
                headStyles: { fillColor: [240, 240, 240], fontStyle: 'bold' },
                margin: { left: margin, right: margin },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { halign: 'center', cellWidth: 40 },
                    2: { fontStyle: 'bold', cellWidth: 50 },
                    3: { halign: 'center', cellWidth: 40 },
                }
            });
            y = doc.autoTable.previous.finalY + 10;


            // --- 5. ZONAL ANALYSIS (Using HTML2Canvas for visual capture) ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("ZONAL ANALYSIS", margin, y);
            y += 5;
            
            // Get the container elements
            const saveContainer = document.getElementById('saveZoneContainer');
            const goalContainer = document.getElementById('goalZoneContainer');
            
            // CRITICAL: Ensure elements are visible for html2canvas
            saveContainer.style.display = 'block';
            goalContainer.style.display = 'block';

            // 1. Capture Save Zones
            const saveCanvas = await html2canvas(saveContainer.querySelector('#save_zones_grid'), { scale: 2 });
            const saveImgData = saveCanvas.toDataURL('image/png');
            const saveImgWidth = 85; // Slightly wider for better visual
            const saveImgHeight = saveCanvas.height * saveImgWidth / saveCanvas.width;

            // 2. Capture Goal Zones
            const goalCanvas = await html2canvas(goalContainer.querySelector('#goals_conceded_grid'), { scale: 2 });
            const goalImgData = goalCanvas.toDataURL('image/png');
            const goalImgWidth = 85;
            const goalImgHeight = goalCanvas.height * goalImgWidth / goalCanvas.width;
            
            // Check for new page if necessary
            if (y + saveImgHeight + 20 > doc.internal.pageSize.getHeight()) {
                doc.addPage();
                y = 20;
            }

            // Draw Titles
            doc.setFontSize(10);
            doc.text("SAVE LOCATION (Saves)", margin, y);
            doc.text("GOAL LOCATION (Goals)", pageWidth / 2 + 5, y); 
            y += 2;

            // Draw Images side by side
            doc.addImage(saveImgData, 'PNG', margin, y, saveImgWidth, saveImgHeight);
            doc.addImage(goalImgData, 'PNG', pageWidth / 2 + 5, y, goalImgWidth, goalImgHeight);
            
            y += saveImgHeight + 5;


            // --- 6. SAVE FILE ---
            const filename = `BBGK_Report_${data.matchDetails.name.replace(/\s/g, '_')}_${data.matchDetails.date}.pdf`;
            doc.save(filename);

            showModal('successModal', `Report saved and PDF generated successfully as: ${filename}`);
        }


        // --- FIREBASE FUNCTIONS ---

        async function initFirebase() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('flex');
            
            if (!firebaseConfig) {
                 showModal('errorModal', 'System configuration not found. Data persistence disabled.');
                 document.getElementById('loadingIndicator').classList.add('hidden');
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        isAuthReady = true;
                        document.getElementById('generateReportBtn').disabled = false;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showModal('errorModal', `System connection error: ${error.message}`);
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }
        
        /**
         * Compiles data, saves to Firestore, and generates the PDF report.
         */
        async function saveAndGenerateReport() {
            if (!isAuthReady || !userId) {
                showModal('errorModal', 'Authentication is not ready. Please wait a moment.');
                return;
            }
            
            const statusMsg = document.getElementById('statusMessage');
            const saveBtn = document.getElementById('generateReportBtn');
            const resetBtn = document.getElementById('resetAppBtn');

            statusMsg.textContent = 'Saving data and preparing report...';
            statusMsg.classList.remove('hidden');
            saveBtn.disabled = true;
            resetBtn.disabled = true;

            const data = getMatchData();
            const documentId = data.matchDetails.gameId;
            
            try {
                // Firestore path: /artifacts/{appId}/users/{userId}/match_logs/{documentId}
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'match_logs', documentId);
                
                await setDoc(docRef, data);
                
                statusMsg.textContent = 'Data saved to cloud. Generating PDF...';
                await generatePDFReport(); 

                statusMsg.textContent = 'Report generated successfully!';

            } catch (error) {
                console.error("Save or PDF Error:", error);
                showModal('errorModal', `Error during save/PDF generation: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                resetBtn.disabled = false;
                statusMsg.classList.add('hidden');
            }
        }
        
        // --- EVENT LISTENERS & MAIN INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup UI first - THIS FIXES THE REFERENCE ERROR
            initializeUI(); 
            
            // Set up main buttons
            document.getElementById('generateReportBtn').addEventListener('click', saveAndGenerateReport);
            document.getElementById('resetAppBtn').addEventListener('click', resetState);

            // Create Icons for UI updates 
            lucide.createIcons();
            
            // Then initialize Firebase
            initFirebase();
        });
    </script>
</body>
</html>
